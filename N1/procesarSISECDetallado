/**
 * Procesa los movimientos laborales de cada patr√≥n detectado.
 * Nivel N1
 */
function N1_procesarSISECDetallado(patronActual, movimientos, fechaBajaGeneral, vigente) {
  let periodos = [];
  let fechaBajaFinal = fechaBajaGeneral;
  if (!fechaBajaFinal) {
    let bajaMovimiento = movimientos.find((mov) => mov.tipo === "BAJA");
    if (bajaMovimiento) fechaBajaFinal = bajaMovimiento.fecha;
  }

  let movimientosValidos = movimientos.filter((mov) => mov.tipo !== "BAJA");
  if (movimientosValidos.length === 0) {
    Logger.log("‚ö†Ô∏è No se encontraron movimientos v√°lidos para " + patronActual);
    return [];
  }

  for (let i = 0; i < movimientosValidos.length; i++) {
    let fechaAlta =
      i === 0 ?
      movimientosValidos[i].fecha : STAFF_AYUDA_restarUnDiaAString(movimientosValidos[i - 1].fecha);
    let salario = movimientosValidos[i].salario;
    let fechaBaja =
      i === 0 ?
      fechaBajaFinal : STAFF_AYUDA_restarUnDiaAString(movimientosValidos[i - 1].fecha);

    periodos.push({
      patron: i === 0 ? patronActual : "",
      alta: fechaAlta,
      baja: fechaBaja,
      salario: salario,
      detallado: true,
    });
  }

  Logger.log("üìÑ Periodos generados para " + patronActual + ": " + JSON.stringify(periodos));
  return periodos;
}
